<?xml version="1.0" encoding="utf-8"?>
<s:NavigatorContent xmlns:fx="http://ns.adobe.com/mxml/2009" 
					xmlns:s="library://ns.adobe.com/flex/spark" 
					xmlns:mx="library://ns.adobe.com/flex/mx" label="分享fb和邀请好友" width="400" height="300" xmlns:comps="poker.comps.*">
	
	<s:layout>
		<s:VerticalLayout horizontalAlign="center" />
	</s:layout>

	<fx:Script>
		<![CDATA[
			import mx.controls.Alert;
			import mx.formatters.DateFormatter;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			
			import poker.Config;
			import poker.events.PaginationEvent;
			import poker.util.DataUtil;
			import poker.util.TimeUtil;
			
			[Bindable]
			private var model : Object;
			
			private var timer:Timer; 
			
			protected function paginateHandler(event:PaginationEvent):void
			{
				search((event.page - 1) * Config.PAGESIZE);
			}
			
			protected function searchButton_clickHandler(event:MouseEvent):void
			{
				search(0);
			}
			
			private function searchEvent(evt:TimerEvent):void{
				search(0);
				var currentLine:int = DataUtil.getCurrentLine(model);
				var totalLine:int = DataUtil.getTotalLine(model);
				var vaPercent:Number = currentLine / totalLine;  
				if(currentLine >= totalLine)  
				{  
					progressBar.setProgress(currentLine, totalLine);  
					progressBar.label = "read completed";  
					return;  
				}  
				progressBar.setProgress(currentLine, totalLine);  
				progressBar.label = (vaPercent * 100) + "% has been readed"
			}
			
			private function search(from : int) : void
			{
				var selectedDate:Date = dateFieldStart.selectedDate;
				var selectedDateStr:String = DateField.dateToString(selectedDate,"YYYY-MM-DD");
				var hour:String = hourInputStart.text;
				var minute:String = minuteInputStart.text;
				var dateParamter:String = selectedDateStr + " " + hour + ":" + minute+ ":00";
				var dateIntStart:int = DateFormatter.parseDateString(dateParamter).getTime()/1000;
				
				selectedDate = dateFieldEnd.selectedDate;
				selectedDateStr = DateField.dateToString(selectedDate,"YYYY-MM-DD");
				hour = hourInputEnd.text;
				minute = minuteInputStart.text;
				dateParamter = selectedDateStr + " " + hour + ":" + minute+ ":00";
				var dateIntEnd:int = DateFormatter.parseDateString(dateParamter).getTime()/1000;
				httpService.send({
					startTime : dateIntStart,
					endTime : dateIntEnd,
					from : from,
					size : Config.PAGESIZE
				});
				
			}
			
			protected function httpService_resultHandler(event:ResultEvent):void
			{
				model = JSON.parse(String(event.result));
				if(model != null && DataUtil.isReading(model)){
					TimeUtil.addEvent(searchEvent);
				}
			}
			
			protected function httpService_faultHandler(event:FaultEvent):void
			{
				Alert.show(event.toString());
			}
			
		]]>
	</fx:Script>
	
	<fx:Declarations>
		<s:HTTPService id="httpService" url="{Config.URLBASE}fbFriend/list.htm" result="httpService_resultHandler(event)" fault="httpService_faultHandler(event)"/>
	</fx:Declarations>
	
	<s:Group>
		<s:layout>
			<s:HorizontalLayout horizontalAlign="center" verticalAlign="middle" gap="5" />
		</s:layout>
		
		<s:Label text="开始时间" />
		<mx:DateField id="dateFieldStart" formatString="YYYY-MM-DD" />
		<s:Label text="小时" />
		<s:TextInput id="hourInputStart"/>
		<s:Label text="分钟" />
		<s:TextInput id="minuteInputStart"/>
		
		<s:Label text="结束时间" />
		<mx:DateField id="dateFieldEnd" formatString="YYYY-MM-DD" />
		<s:Label text="小时" />
		<s:TextInput id="hourInputEnd"/>
		<s:Label text="分钟" />
		<s:TextInput id="minuteInputEnd"/>
		
		<s:Button id="searchButton" label="查询" click="searchButton_clickHandler(event)" />
		
	</s:Group>
	
	<s:Line width="100%">
		<s:stroke>
			<s:SolidColorStroke color="0xeeeeee" />
		</s:stroke>
	</s:Line>
	
	<s:DataGrid width="100%" height="500">
		<s:columns>
			<s:ArrayList>
				<!--<s:GridColumn dataField="gameType" headerText="玩法id"/>-->
				<s:GridColumn dataField="userId" headerText="用户id"/>
				<s:GridColumn dataField="inviteFriendCount" headerText="邀请好友数"/>
				<s:GridColumn dataField="shareFbCount" headerText="分享fb数"/>
			</s:ArrayList>
		</s:columns>
		<s:ArrayCollection source="{model.list}" />
	</s:DataGrid>
	
	
	<mx:ProgressBar x="108" y="22"
					label="0% has been downloaded" 
					minimum="0" maximum="100"
					mode="manual" id="progressBar" 
					name="progress" indeterminate="false" 
					enabled="true" 
					chromeColor="#1F1616" color="#FB0D0D" 
					disabledColor="#FA1919" errorColor="#26AE4D"/>	
	
	<comps:Paginator id="paginator" paginate="paginateHandler(event)" page="{DataUtil.getPage(model)}" total="{DataUtil.getTotal(model)}"/>

</s:NavigatorContent>
